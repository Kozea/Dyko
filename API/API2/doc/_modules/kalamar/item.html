

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>kalamar.item &mdash; Test v0.2 documentation</title>
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.2',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="Test v0.2 documentation" href="../../index.html" />
    <link rel="up" title="kalamar" href="../kalamar.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">Test v0.2 documentation</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li>
          <li><a href="../kalamar.html" accesskey="U">kalamar</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for kalamar.item</h1><div class="highlight"><pre>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="c"># This file is part of Dyko</span>
<span class="c"># Copyright © 2008-2009 Kozea</span>
<span class="c">#</span>
<span class="c"># This library is free software: you can redistribute it and/or modify</span>
<span class="c"># it under the terms of the GNU General Public License as published by</span>
<span class="c"># the Free Software Foundation, either version 3 of the License, or</span>
<span class="c"># (at your option) any later version.</span>
<span class="c">#</span>
<span class="c"># This library is distributed in the hope that it will be useful,</span>
<span class="c"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c"># GNU General Public License for more details.</span>
<span class="c">#</span>
<span class="c"># You should have received a copy of the GNU General Public License</span>
<span class="c"># along with Kalamar.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Base classes to create kalamar items.</span>

<span class="sd">Parsers must:</span>
<span class="sd">- inherit from Item</span>
<span class="sd">- have a ``format`` class attribute as a string,</span>
<span class="sd">- extend or override the _parse_data method,</span>
<span class="sd">- override the serialize method.</span>

<span class="sd">The ``format`` string is used to identify the parser in configuration files</span>
<span class="sd">and must be unique.</span>

<span class="sd">See BinaryItem for a very simple example.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">werkzeug</span> <span class="kn">import</span> <span class="n">MultiDict</span><span class="p">,</span> <span class="n">cached_property</span>
    
<span class="kn">from</span> <span class="nn">kalamar</span> <span class="kn">import</span> <span class="n">parser</span><span class="p">,</span> <span class="n">utils</span>
<span class="kn">from</span> <span class="nn">kalamar.requestparser</span> <span class="kn">import</span> <span class="n">reverse_convert_value</span>



<div class="viewcode-block" id="Item"><a class="viewcode-back" href="../../kalamar.html#kalamar.item.Item">[docs]</a><span class="k">class</span> <span class="nc">Item</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for parsers.</span>
<span class="sd">    </span>
<span class="sd">    Items dictionnary-like: you can use the item[&#39;…&#39;] syntax to get and set</span>
<span class="sd">    properties. Missing properties default to None.</span>
<span class="sd">    </span>
<span class="sd">    The _access_point attribute represents where, in kalamar, the item is</span>
<span class="sd">    stored. It is an instance of AccessPoint.</span>

<span class="sd">    Items are hashable but mutable, use hash with caution.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># TODO: use the MultiDict power by coding getlist/setlist (or not?)</span>
    <span class="n">format</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">access_point</span><span class="p">,</span> <span class="n">opener</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">storage_properties</span><span class="o">=</span><span class="p">{}):</span>
        <span class="sd">&quot;&quot;&quot;This constructor should not be used directly.</span>
<span class="sd">        Get items from AccessPoint’s or use Item.create_item to create them.</span>
<span class="sd">        </span>
<span class="sd">        Parameters:</span>
<span class="sd">        - access_point: an instance of the AccessPoint class.</span>
<span class="sd">        - opener: a function taking no parameters and returning the item raw</span>
<span class="sd">          “content” as a bytestring, or the empty string.</span>
<span class="sd">        - storage_properties: properties generated by the storage for this</span>
<span class="sd">          item.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_opener</span> <span class="o">=</span> <span class="n">opener</span> <span class="ow">or</span> <span class="nb">str</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_raw_content</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_raw_content_mimetype</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_access_point</span> <span class="o">=</span> <span class="n">access_point</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_access_point_name</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">storage_modified</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parser_modified</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_request</span> <span class="o">=</span> <span class="bp">None</span>
        
        <span class="c"># Used when an item is contained into a capsule</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">association_properties</span> <span class="o">=</span> <span class="p">{}</span>
        
        
        <span class="bp">self</span><span class="o">.</span><span class="n">storage_aliases</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">access_point</span><span class="o">.</span><span class="n">storage_aliases</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parser_aliases</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">access_point</span><span class="o">.</span><span class="n">parser_aliases</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">raw_storage_properties</span> <span class="o">=</span> <span class="n">MultiDict</span><span class="p">(</span><span class="n">storage_properties</span><span class="p">)</span>
        
        <span class="c"># Keep this one to track modifications made to raw_parser_properties</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">old_storage_properties</span> <span class="o">=</span> <span class="n">MultiDict</span><span class="p">(</span><span class="n">storage_properties</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">storage_properties</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">AliasedMultiDict</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">raw_storage_properties</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage_aliases</span><span class="p">)</span>
        
    <span class="nd">@cached_property</span>
<div class="viewcode-block" id="Item.raw_parser_properties"><a class="viewcode-back" href="../../kalamar.html#kalamar.item.Item.raw_parser_properties">[docs]</a>    <span class="k">def</span> <span class="nf">raw_parser_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The “parser” counterpart of raw_storage_properties. A MultiDict.</span>
<span class="sd">        </span>
<span class="sd">        Parser properties are lazy: only parse when needed.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">MultiDict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parse_data</span><span class="p">())</span>
</div>
    <span class="nd">@cached_property</span>
<div class="viewcode-block" id="Item.parser_properties"><a class="viewcode-back" href="../../kalamar.html#kalamar.item.Item.parser_properties">[docs]</a>    <span class="k">def</span> <span class="nf">parser_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The “parser” counterpart of storage_properties.</span>
<span class="sd">        </span>
<span class="sd">        This is also a cached_property because we need the actual</span>
<span class="sd">        raw_parser_properties MultiDict to instanciate it.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">utils</span><span class="o">.</span><span class="n">AliasedMultiDict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_parser_properties</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">parser_aliases</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_is_storage_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Determine wether this key is storage property or parser property.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage_aliases</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser_aliases</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage_properties</span>
    
    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the item ``key`` property.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_storage_key</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage_properties</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser_properties</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
    
    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the item ``key`` property to ``value``.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_storage_key</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">storage_properties</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">storage_modified</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parser_properties</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parser_modified</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test if ``item`` is the same as this item.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">Item</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">==</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">NotImplemented</span>

    <span class="k">def</span> <span class="nf">__cmp__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compare two items.</span>
<span class="sd">        </span>
<span class="sd">        Useful in some algorithms (sorting by key, for example).</span>
<span class="sd">        DO NOT USE UNLESS YOU KNOW WHAT YOU&#39;RE DOING!</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">Item</span><span class="p">):</span>
            <span class="n">str1</span> <span class="o">=</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">str2</span> <span class="o">=</span> <span class="nb">hash</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">cmp</span><span class="p">(</span><span class="n">str1</span><span class="p">,</span> <span class="n">str2</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">NotImplemented</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a user-friendly representation of item.&quot;&quot;&quot;</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span>
                  <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">),</span>
                  <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">access_point_name</span><span class="p">))</span>
        <span class="k">return</span> <span class="s">&#39;&lt;</span><span class="si">%s</span><span class="s">(</span><span class="si">%s</span><span class="s"> @ </span><span class="si">%s</span><span class="s">)&gt;&#39;</span> <span class="o">%</span> <span class="n">values</span>
    
    <span class="k">def</span> <span class="nf">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a hash of item.</span>
<span class="sd">        </span>
<span class="sd">        Do not forget that items are mutable, so the hash could change!</span>
<span class="sd">        </span>
<span class="sd">        This hash value is useful in some algorithms (eg in sets) and it</span>
<span class="sd">        permits a huge gain of performance. However, DON&#39;T USE THIS HASH UNLESS</span>
<span class="sd">        YOU KNOW WHAT YOU&#39;RE DOING.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">access_point_name</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Item.create_item"><a class="viewcode-back" href="../../kalamar.html#kalamar.item.Item.create_item">[docs]</a>    <span class="k">def</span> <span class="nf">create_item</span><span class="p">(</span><span class="n">access_point</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">initial_content</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a new item instance.</span>
<span class="sd">        </span>
<span class="sd">        Parameters:</span>
<span class="sd">        - ``access_point``: instance of the access point where the item</span>
<span class="sd">          will be reachable (after saving).</span>
<span class="sd">        - ``properties``: dictionnary or MultiDict of the item properties.</span>
<span class="sd">          These properties must be coherent with what is defined for the</span>
<span class="sd">          access point.</span>
<span class="sd">        - ``initial_content``: some initial content for parsers needing it.</span>
<span class="sd">        </span>
<span class="sd">        Fixture</span>
<span class="sd">        &gt;&gt;&gt; from _test.corks import CorkAccessPoint</span>
<span class="sd">        &gt;&gt;&gt; ap = CorkAccessPoint()</span>
<span class="sd">        &gt;&gt;&gt; properties = {}</span>
<span class="sd">        </span>
<span class="sd">        Test</span>
<span class="sd">        &gt;&gt;&gt; item = Item.create_item(ap, properties)</span>
<span class="sd">        &gt;&gt;&gt; assert item.format == ap.parser_name</span>
<span class="sd">        &gt;&gt;&gt; assert isinstance(item, Item)</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">storage_properties</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span>
                                  <span class="ow">in</span> <span class="n">access_point</span><span class="o">.</span><span class="n">get_storage_properties</span><span class="p">())</span>
        
        <span class="n">item_parser</span> <span class="o">=</span> <span class="n">Item</span><span class="o">.</span><span class="n">_find_parser</span><span class="p">(</span><span class="n">access_point</span><span class="p">)</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">item_parser</span><span class="p">(</span><span class="n">access_point</span><span class="p">,</span>
                           <span class="n">storage_properties</span><span class="o">=</span><span class="n">storage_properties</span><span class="p">,</span>
                           <span class="n">opener</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">initial_content</span><span class="p">)</span>
        
        <span class="c"># old_storage_properties is meaningless for a new item.</span>
        <span class="n">item</span><span class="o">.</span><span class="n">old_storage_properties</span> <span class="o">=</span> <span class="n">MultiDict</span><span class="p">()</span>
                
        <span class="k">if</span> <span class="n">properties</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">properties</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">item</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">return</span> <span class="n">item</span>
</div>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_find_parser</span><span class="p">(</span><span class="n">access_point</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the parser class set for the given access point.</span>
<span class="sd">        </span>
<span class="sd">        Your kalamar distribution should have, at least, a parser for the</span>
<span class="sd">        ``binary`` format.</span>
<span class="sd">        </span>
<span class="sd">        &gt;&gt;&gt; from _test.corks import CorkAccessPoint</span>
<span class="sd">        &gt;&gt;&gt; ap = CorkAccessPoint()</span>
<span class="sd">        &gt;&gt;&gt; ap.parser_name = &#39;binary&#39;</span>
<span class="sd">        &gt;&gt;&gt; Item._find_parser(ap)</span>
<span class="sd">        &lt;class &#39;kalamar.item.BinaryItem&#39;&gt;</span>
<span class="sd">        </span>
<span class="sd">        An invalid format will raise a ValueError:</span>
<span class="sd">        &gt;&gt;&gt; ap.parser_name = &#39;I do not exist&#39;</span>
<span class="sd">        &gt;&gt;&gt; Item._find_parser(ap)</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">        ...</span>
<span class="sd">        ParserNotAvailable: Unknown parser: I do not exist</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">access_point</span><span class="o">.</span><span class="n">parser_name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Item</span>
        
        <span class="k">for</span> <span class="n">subclass</span> <span class="ow">in</span> <span class="n">utils</span><span class="o">.</span><span class="n">recursive_subclasses</span><span class="p">(</span><span class="n">Item</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">subclass</span><span class="p">,</span> <span class="s">&#39;format&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="o">==</span> <span class="n">access_point</span><span class="o">.</span><span class="n">parser_name</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">subclass</span>
        
        <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">ParserNotAvailable</span><span class="p">(</span><span class="s">&#39;Unknown parser: &#39;</span> <span class="o">+</span>
                                       <span class="n">access_point</span><span class="o">.</span><span class="n">parser_name</span><span class="p">)</span>

    <span class="nd">@property</span>
<div class="viewcode-block" id="Item.encoding"><a class="viewcode-back" href="../../kalamar.html#kalamar.item.Item.encoding">[docs]</a>    <span class="k">def</span> <span class="nf">encoding</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the item encoding.</span>

<span class="sd">        Return the item encoding, based on what the parser can know from</span>
<span class="sd">        the item data or, if unable to do so, on what is specified in the</span>
<span class="sd">        access_point.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_access_point</span><span class="o">.</span><span class="n">default_encoding</span>
    </div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Item.modified"><a class="viewcode-back" href="../../kalamar.html#kalamar.item.Item.modified">[docs]</a>    <span class="k">def</span> <span class="nf">modified</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return if the item has been modified since creation.</span>

<span class="sd">        The item is considered changed if any storage or parser property has</span>
<span class="sd">        been changed since its creation.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage_modified</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser_modified</span>
    </div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Item.filename"><a class="viewcode-back" href="../../kalamar.html#kalamar.item.Item.filename">[docs]</a>    <span class="k">def</span> <span class="nf">filename</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the file path.</span>

<span class="sd">        If the item is stored in a file, return its path/name.</span>
<span class="sd">        Else return None.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_access_point</span><span class="p">,</span> <span class="s">&#39;filename_for&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_access_point</span><span class="o">.</span><span class="n">filename_for</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    </div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Item.request"><a class="viewcode-back" href="../../kalamar.html#kalamar.item.Item.request">[docs]</a>    <span class="k">def</span> <span class="nf">request</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a request sufficient to find this item and only this one.</span>

<span class="sd">        This ``request`` must be canonical. As a consequence, opening an item</span>
<span class="sd">        twice should give the same ``request``, even if the request used for</span>
<span class="sd">        opening the items are not the same.</span>

<span class="sd">        This property is used for testing item equality.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">conditions</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s">u&#39;</span><span class="si">%s</span><span class="s">=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">reverse_convert_value</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_access_point</span><span class="o">.</span><span class="n">primary_keys</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_request</span> <span class="o">=</span> <span class="s">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">conditions</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span>
    </div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Item.access_point_name"><a class="viewcode-back" href="../../kalamar.html#kalamar.item.Item.access_point_name">[docs]</a>    <span class="k">def</span> <span class="nf">access_point_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a request sufficient to find this item and only this one.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_access_point_name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_access_point_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_access_point</span><span class="o">.</span><span class="n">name</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_access_point_name</span>
</div>
<div class="viewcode-block" id="Item.keys"><a class="viewcode-back" href="../../kalamar.html#kalamar.item.Item.keys">[docs]</a>    <span class="k">def</span> <span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the name of all properties.&quot;&quot;&quot;</span>
        <span class="c"># Use a set to make keys unique</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage_properties</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">+</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">parser_properties</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
</div>
    <span class="k">def</span> <span class="nf">_parse_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse properties from data, return a dictionnary (MultiDict).</span>
<span class="sd">        </span>
<span class="sd">        This method should use ``self._get_content()`` parse the result,</span>
<span class="sd">        and return a MultiDict.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">MultiDict</span><span class="p">()</span>

<div class="viewcode-block" id="Item.serialize"><a class="viewcode-back" href="../../kalamar.html#kalamar.item.Item.serialize">[docs]</a>    <span class="k">def</span> <span class="nf">serialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return raw content as bytestring.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s">&#39;&#39;</span>
</div>
<div class="viewcode-block" id="Item.test_condition"><a class="viewcode-back" href="../../kalamar.html#kalamar.item.Item.test_condition">[docs]</a>    <span class="k">def</span> <span class="nf">test_condition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">condition</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return True if item properties matches this condition.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">condition</span><span class="o">.</span><span class="n">operator</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">condition</span><span class="o">.</span><span class="n">property_name</span><span class="p">],</span> <span class="n">condition</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_get_content</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the raw content as a bytestring, to be parsed.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw_content</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_raw_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_opener</span><span class="p">()</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw_content</span>


</div>
<span class="k">class</span> <span class="nc">BinaryItem</span><span class="p">(</span><span class="n">Item</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Simple parser giving access to raw content as ``data`` property.&quot;&quot;&quot;</span>
    <span class="n">format</span> <span class="o">=</span> <span class="s">&#39;binary&#39;</span>
    
    <span class="k">def</span> <span class="nf">_parse_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse the whole item content.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">MultiDict</span><span class="p">({</span><span class="s">&#39;data&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_content</span><span class="p">()})</span>
        
    <span class="k">def</span> <span class="nf">serialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the item content.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_parser_properties</span><span class="p">[</span><span class="s">&#39;data&#39;</span><span class="p">]</span>



<span class="k">class</span> <span class="nc">CapsuleItem</span><span class="p">(</span><span class="n">Item</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An ordered list of Items (atoms or capsules).</span>

<span class="sd">    This is an abstract class.</span>
<span class="sd">    Subclasses need to override the ``_load_subitems`` method.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">access_point</span><span class="p">,</span> <span class="n">opener</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">storage_properties</span><span class="o">=</span><span class="p">{}):</span>
        <span class="sd">&quot;&quot;&quot;Return an instance of CapsuleItem.</span>
<span class="sd">        </span>
<span class="sd">        Parameters:</span>
<span class="sd">        - access_point: an instance of the AccessPoint class.</span>
<span class="sd">        - opener: a function taking no parameters and returning file-like</span>
<span class="sd">          object.</span>
<span class="sd">        - storage_properties: properties generated by the storage for this</span>
<span class="sd">          item.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CapsuleItem</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span>
            <span class="n">access_point</span><span class="p">,</span> <span class="n">opener</span><span class="p">,</span> <span class="n">storage_properties</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parser_modified</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the item ``key`` property.</span>

<span class="sd">        If ``key`` is an integer, return the ``subitems[key]`` value. Else,</span>
<span class="sd">        return the atom ``key`` property.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">slice</span><span class="p">)):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">subitems</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">CapsuleItem</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__getitem__</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the item ``key`` property to ``value``.</span>

<span class="sd">        If ``key`` is an integer, set the ``subitems[key]`` to value. Else,</span>
<span class="sd">        set the atom ``key`` property to ``value``.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subitems</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">CapsuleItem</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get capsule length.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subitems</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return True if ``item`` is in capsule.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subitems</span>

    <span class="k">def</span> <span class="nf">_get_subitems</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List of the capsule subitems.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;_subitems&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_subitems</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">ModificationTrackingList</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_load_subitems</span><span class="p">())</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subitems</span>

    <span class="k">def</span> <span class="nf">_set_subitems</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the list of the capsule subitems.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_subitems</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">ModificationTrackingList</span><span class="p">(</span><span class="n">new_list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_subitems</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="bp">True</span>
    
    <span class="n">subitems</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_subitems</span><span class="p">,</span> <span class="n">_set_subitems</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">_get_parser_modified</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Capsule parser_modified getter.</span>

<span class="sd">        This getter assumes that the capsule content is modified when:</span>
<span class="sd">        - one subitem (parser or storage) property has been modified, or</span>
<span class="sd">        - one capsule parser property has been modified.</span>

<span class="sd">        This situation should be right for most cases, particularly if the</span>
<span class="sd">        whole subitems are embedded in the capsule (movies, archives, etc.).</span>

<span class="sd">        If the subitems are just linked (ReStructuredText, etc.), this should</span>
<span class="sd">        work too but could be optimized. You can override this function by</span>
<span class="sd">        ``return self._parser_modified`` in this case.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parser_modified</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">subitems</span><span class="o">.</span><span class="n">modified</span>

    <span class="k">def</span> <span class="nf">_set_parser_modified</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Capsule parser_modified setter.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parser_modified</span> <span class="o">=</span> <span class="n">value</span>
        
    <span class="n">parser_modified</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_parser_modified</span><span class="p">,</span> <span class="n">_set_parser_modified</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_load_subitems</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load and return capsule subitems.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&#39;Abstract class&#39;</span><span class="p">)</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">Test v0.2 documentation</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li>
          <li><a href="../kalamar.html" >kalamar</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2010, Test.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0b2.
    </div>
  </body>
</html>